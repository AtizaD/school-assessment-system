# VC Assessment System - Clean URLs Configuration
RewriteEngine On

# Set base directory to root
RewriteBase /

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# Security - Block sensitive files
<Files ~ "(\.log|\.sql|\.inc|\.bak|\.backup|\.env)$">
    Require all denied
</Files>

<FilesMatch "^(database|config|auth)\.php$">
    Require all denied
</FilesMatch>

# Block access to config directory
<IfModule mod_rewrite.c>
    RewriteRule ^config/ - [F,L]
    RewriteRule ^includes/ - [F,L]
    RewriteRule ^vendor/ - [F,L]
</IfModule>

# Disable directory browsing
Options -Indexes

# Admin routes
RewriteRule ^admin/?$ admin/index.php [L]
RewriteRule ^admin/dashboard/?$ admin/index.php [L]
RewriteRule ^admin/users/?$ admin/users.php [L]
RewriteRule ^admin/programs/?$ admin/programs.php [L]
RewriteRule ^admin/classes/?$ admin/classes.php [L]
RewriteRule ^admin/subjects/?$ admin/subjects.php [L]
RewriteRule ^admin/semesters/?$ admin/semesters.php [L]
RewriteRule ^admin/settings/?$ admin/settings.php [L]
RewriteRule ^admin/payment-tracking/?$ admin/payment_tracking.php [L]
RewriteRule ^admin/export-payments/?$ admin/export_payments.php [L]
RewriteRule ^admin/audit-logs/?$ admin/audit-logs.php [L]
RewriteRule ^admin/performance/?$ admin/performance_dashboard.php [L]
RewriteRule ^admin/results/?$ admin/generate_results.php [L]
RewriteRule ^admin/reset-passwords/?$ admin/reset_passwords.php [L]

# Teacher routes
RewriteRule ^teacher/?$ teacher/index.php [L]
RewriteRule ^teacher/dashboard/?$ teacher/index.php [L]
RewriteRule ^teacher/assessments/?$ teacher/assessments.php [L]
RewriteRule ^teacher/students/?$ teacher/students.php [L]
RewriteRule ^teacher/results/?$ teacher/results.php [L]
RewriteRule ^teacher/subjects/?$ teacher/subjects.php [L]
RewriteRule ^teacher/questions/?$ teacher/question-bank.php [L]
RewriteRule ^teacher/create-assessment/?$ teacher/create_assessment.php [L]
RewriteRule ^teacher/reports/?$ teacher/reports.php [L]
RewriteRule ^teacher/settings/?$ teacher/settings.php [L]

# Student routes
RewriteRule ^student/?$ student/index.php [L]
RewriteRule ^student/dashboard/?$ student/index.php [L]
RewriteRule ^student/assessments/?$ student/assessments.php [L]
RewriteRule ^student/results/?$ student/results.php [L]
RewriteRule ^student/subjects/?$ student/subjects.php [L]
RewriteRule ^student/schedule/?$ student/schedule.php [L]
RewriteRule ^student/progress/?$ student/progress.php [L]
RewriteRule ^student/take-assessment/?$ student/take_assessment.php [L]
RewriteRule ^student/payment/?$ student/payment.php [L]
RewriteRule ^student/settings/?$ student/settings.php [L]

# API routes
RewriteRule ^api/check-maintenance/?$ api/check_maintenance.php [L]
RewriteRule ^api/payment-check/?$ api/payment_check_api.php [L]
RewriteRule ^api/grade-assessment/?$ api/grade_assessment.php [L]
RewriteRule ^api/take-assessment/?$ api/take_assessment.php [L]

# Webhook routes
RewriteRule ^webhook/paystack/?$ webhook/paystack.php [L]

# Main routes
RewriteRule ^login/?$ login.php [L]
RewriteRule ^register/?$ register.php [L]
RewriteRule ^logout/?$ includes/bass/logout.php [L]
RewriteRule ^change-password/?$ change-password.php [L]
RewriteRule ^payment/?$ payment.php [L]
RewriteRule ^verify-payment/?$ verify_payment.php [L]
RewriteRule ^payment-callback/?$ verify_payment_callback.php [L]
RewriteRule ^initiate-payment/?$ initiate_payment.php [L]

# Allow existing files to be accessed directly
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule .* - [L]

# Allow existing directories to be accessed directly
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule .* - [L]

# Fallback to index.php for unmatched routes
RewriteRule ^(.*)$ index.php [L,QSA]

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options SAMEORIGIN
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# Compression
<IfModule mod_deflate.c>
    <FilesMatch "\.(css|js|html|htm|php|xml|json)$">
        SetOutputFilter DEFLATE
    </FilesMatch>
</IfModule>

# Cache control for static assets
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 month"
    ExpiresByType image/jpeg "access plus 1 month"
    ExpiresByType image/png "access plus 1 month"
    ExpiresByType image/gif "access plus 1 month"
    ExpiresByType text/css "access plus 1 week"
    ExpiresByType application/javascript "access plus 1 week"
</IfModule>